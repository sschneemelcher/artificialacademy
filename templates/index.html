<!DOCTYPE html>

<head>
  <title>artificial.academy</title>
  <link rel="shortcut icon" href="{{ url_for('static', filename='rect968.png.png') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>

<body style="background-color: #11111b">
  <nav class="navbar navbar-expand-md navbar-dark fixed-top pt-4" style="background-color: #11111b">
    <div class="container-fluid" style="width: 100vw; background-color: #11111b">
      <a class="navbar-brand" href="#">artificial.academy</a>
    </div>
  </nav>
  <div class="container pb-5">
    <div class="row">
      <div class="col-md-6 offset-md-3">
        <div class="card mt-5">
          <div class="card-body">
            <div id="chat-window">
            </div>
          </div>
        </div>
        <div class="container sticky-bottom pb-4">
          <div class="input-group row g-1 mt-1">
            <textarea id="chat-input" class="form-control" placeholder="Tell StudyBot what you need help with." rows="2"
              autofocus></textarea>
            <div class="d-grid gap-2">
              <button id="send-button" type="button" class="btn btn-primary" disabled>
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Get references to the input field and send button
    const inputField = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    const messageClassList = 'fs-3 font-weight-bold mb-3 card';

    // Get a reference to the chat window
    const chatWindow = document.getElementById('chat-window');

    const sendMessage = () => {
      // Get the message from the input field
      const message = inputField.value;

      // Clear the input field
      inputField.value = '';

      // Create a new element to display the message
      const messageElement = document.createElement('div');
      messageElement.classList += ` text-end bg-secondary text-light ${messageClassList}`;
      messageElement.innerText = `${message}`;

      // Add the message to the chat window
      chatWindow.appendChild(messageElement);

      let chatHistory = '';
      for (c of chatWindow.children) {
        chatHistory += `${c.classList.contains('request') ? 'Student' : 'StudyBot'}: ${c.innerText}\n`;
      }

      // Send a POST request to the server with the updated chat history
      fetch('/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `history=${chatHistory}`
      })
        .then(response => response.text())
        .then(result => {
          // Display the server's response in the chat window
          const responseElement = document.createElement('div');
          responseElement.classList += ` bg-dark text-light ${messageClassList}`;
          responseElement.innerText = `${result}`;
          chatWindow.appendChild(responseElement);
        })

      window.scrollTo(0, document.body.scrollHeight);
    }

    let shiftActive = false;
    // Add an event listener to the input field that listens for the keydown event
    inputField.addEventListener('keydown', event => {
      (event.key === 'Enter' && !shiftActive) && inputField.value.length && (event.preventDefault() || sendMessage());
      (event.key === 'Enter' && !shiftActive) && !inputField.value.length && event.preventDefault();
      (event.key === 'Shift') && (shiftActive = true);
    });

    inputField.addEventListener('keyup', event => {
      (event.key === 'Shift') && (shiftActive = false);
      if (inputField.value.length)
        sendButton.removeAttribute('disabled')
      else sendButton.setAttribute('disabled', '');
    });

    // Add an event listener to the send button
    sendButton.addEventListener('click', sendMessage)

  </script>
</body>